# üöÄ Guia Completo - DarkStack API Testing

## üì¶ O que voc√™ vai importar

**2 arquivos apenas:**
1. `darkstack-environment.json` - Vari√°veis de ambiente
2. `darkstack-complete-collection.json` - Collection completa com tudo

**O que est√° incluso:**
- ‚úÖ Autentica√ß√£o (login, tokens, refresh)
- ‚úÖ Artigos (CRUD, busca, modera√ß√£o, estat√≠sticas)
- ‚úÖ Coment√°rios (CRUD, threads, modera√ß√£o)
- ‚úÖ WebSocket (tempo real, notifica√ß√µes)
- ‚úÖ Testes avan√ßados (seguran√ßa, performance, edge cases)
- ‚úÖ Scripts autom√°ticos (valida√ß√µes, relat√≥rios)

---

## üõ†Ô∏è Importa√ß√£o no Postman

### Passo 1: Importar os Arquivos

1. **Abra o Postman**
2. **Clique em Import** (bot√£o azul no canto superior esquerdo)
3. **Arraste os 2 arquivos JSON** ou clique em "Upload Files"
4. **Confirme a importa√ß√£o**

### Passo 2: Configurar Environment

1. **No canto superior direito**, selecione **"DarkStack API Environment"**
2. **Verifique se `baseUrl` est√° correto**: `http://localhost:3001`
3. **As outras vari√°veis** ser√£o preenchidas automaticamente

### Passo 3: Verificar Importa√ß√£o

Voc√™ deve ver:
- ‚úÖ Environment: "DarkStack API Environment"
- ‚úÖ Collection: "DarkStack Complete API Collection" com 9 pastas

---

## üéØ Ordem de Execu√ß√£o (IMPORTANTE!)

### üìã Execu√ß√£o Sequencial Recomendada

```
1. üîê 1. AUTENTICA√á√ÉO
   ‚îú‚îÄ‚îÄ Create Regular User
   ‚îú‚îÄ‚îÄ Create Moderator User  
   ‚îú‚îÄ‚îÄ Login as Regular User ‚≠ê (OBRIGAT√ìRIO primeiro)
   ‚îú‚îÄ‚îÄ Login as Moderator ‚≠ê (OBRIGAT√ìRIO)
   ‚îî‚îÄ‚îÄ Get My Profile

2. üìù 2. ARTIGOS - CRUD
   ‚îú‚îÄ‚îÄ Create Article ‚≠ê (salva testArticleId)
   ‚îú‚îÄ‚îÄ Get Article by ID
   ‚îú‚îÄ‚îÄ Get Article by Slug
   ‚îú‚îÄ‚îÄ Update Article
   ‚îî‚îÄ‚îÄ Delete Article (opcional)

3. üìã 3. ARTIGOS - BUSCA E LISTAGEM
   ‚îú‚îÄ‚îÄ List All Articles
   ‚îú‚îÄ‚îÄ My Articles
   ‚îú‚îÄ‚îÄ Search Articles
   ‚îî‚îÄ‚îÄ Popular Tags

4. üõ°Ô∏è 4. ARTIGOS - MODERA√á√ÉO (token moderador)
   ‚îú‚îÄ‚îÄ Pending Articles for Moderation
   ‚îú‚îÄ‚îÄ Approve Article ‚≠ê (usar moderatorToken)
   ‚îú‚îÄ‚îÄ Reject Article
   ‚îî‚îÄ‚îÄ Article Statistics

5. üí¨ 5. COMENT√ÅRIOS - CRUD
   ‚îú‚îÄ‚îÄ Create Root Comment ‚≠ê (salva testCommentId)
   ‚îú‚îÄ‚îÄ Create Reply Comment
   ‚îú‚îÄ‚îÄ Update Comment
   ‚îî‚îÄ‚îÄ Delete Comment

6. üìã 6. COMENT√ÅRIOS - LISTAGEM
   ‚îú‚îÄ‚îÄ List Comments for Article
   ‚îú‚îÄ‚îÄ Count Comments
   ‚îî‚îÄ‚îÄ Find Replies to Comment

7. üõ°Ô∏è 7. COMENT√ÅRIOS - MODERA√á√ÉO
   ‚îú‚îÄ‚îÄ Pending Comments for Moderation
   ‚îú‚îÄ‚îÄ Approve Comment
   ‚îú‚îÄ‚îÄ Reject Comment
   ‚îî‚îÄ‚îÄ Comment Statistics

8. üîå 8. WEBSOCKET - TEMPO REAL
   ‚îú‚îÄ‚îÄ WebSocket Status
   ‚îú‚îÄ‚îÄ WebSocket Health Check
   ‚îú‚îÄ‚îÄ Test: Create Article (Triggers Real-time)
   ‚îú‚îÄ‚îÄ Test: Create Comment (Triggers Real-time)
   ‚îî‚îÄ‚îÄ Test: Approve Article (Triggers Notification)

9. üß™ 9. TESTES AVAN√áADOS
   ‚îú‚îÄ‚îÄ Create Article with Invalid Data
   ‚îú‚îÄ‚îÄ Create Comment with XSS Attempt
   ‚îú‚îÄ‚îÄ Regular User Try to Moderate
   ‚îú‚îÄ‚îÄ Search Performance Test
   ‚îú‚îÄ‚îÄ View Count Accuracy Test
   ‚îî‚îÄ‚îÄ Generate Test Report ‚≠ê (executar por √∫ltimo)
```

---

## üîå Como Configurar WebSocket no Postman

### ‚ö†Ô∏è IMPORTANTE: Use Postman Desktop

**WebSocket N√ÉO funciona no Postman Web!** Baixe o Postman Desktop.

### Passo 1: Criar Conex√£o WebSocket

1. **Postman Desktop** ‚Üí **New** ‚Üí **WebSocket Request**
2. **URL**: `ws://localhost:3001/notifications`

### Passo 2: Autentica√ß√£o

**Escolha uma das op√ß√µes:**

**Op√ß√£o A: Query Parameter**
```
ws://localhost:3001/notifications?token=SEU_TOKEN_AQUI
```

**Op√ß√£o B: Headers**
```
Authorization: Bearer SEU_TOKEN_AQUI
```

### Passo 3: Conectar

1. **Clique em "Connect"**
2. **Aguarde mensagem de confirma√ß√£o**:
```json
{
  "type": "connected",
  "message": "Conectado ao sistema de notifica√ß√µes",
  "userId": "seu-user-id",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### Passo 4: Testar Mensagens

**Ping/Pong (heartbeat):**
```json
{
  "event": "ping"
}
```

**Entrar na sala de moderadores:**
```json
{
  "event": "joinRoom",
  "data": {
    "room": "moderators"
  }
}
```

**Assistir artigo espec√≠fico:**
```json
{
  "event": "watchEntity",
  "data": {
    "targetType": "ARTICLE",
    "targetId": "COLE_AQUI_O_ID_DO_ARTIGO"
  }
}
```

---

## üé¨ Cen√°rios de Teste em Tempo Real

### üéØ Cen√°rio 1: Fluxo Completo de Artigo

**Setup:**
- **WebSocket 1**: Moderador (para receber solicita√ß√µes)
- **WebSocket 2**: Usu√°rio comum (para receber aprova√ß√µes)

**Passos:**
1. **Conectar ambos WebSockets**
2. **Moderador envia**: `{"event": "joinRoom", "data": {"room": "moderators"}}`
3. **Usu√°rio cria artigo** via Collection (se√ß√£o 2)
4. **Moderador recebe**: evento `newModerationRequest`
5. **Moderador aprova** via Collection (se√ß√£o 4)
6. **Usu√°rio recebe**: evento `newNotification` de aprova√ß√£o

### üéØ Cen√°rio 2: Coment√°rios em Tempo Real

**Setup:**
- **WebSocket 1**: Usu√°rio A (assiste artigo)
- **WebSocket 2**: Usu√°rio B (comenta)

**Passos:**
1. **Usu√°rio A envia**: `{"event": "watchEntity", "data": {"targetType": "ARTICLE", "targetId": "ID_ARTIGO"}}`
2. **Usu√°rio B cria coment√°rio** via Collection (se√ß√£o 5)
3. **Usu√°rio A recebe**: evento `newComment`
4. **Usu√°rio B edita coment√°rio** via Collection
5. **Ambos recebem**: evento `commentUpdated`

---

## üìä Eventos WebSocket que Voc√™ Receber√°

### üîî Nova Notifica√ß√£o
```json
{
  "type": "notification",
  "data": {
    "title": "Artigo aprovado! üéâ",
    "message": "Seu artigo foi aprovado...",
    "type": "ARTICLE_APPROVED",
    "relatedId": "article-id"
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### üõ°Ô∏è Solicita√ß√£o de Modera√ß√£o
```json
{
  "type": "moderation",
  "data": {
    "title": "Novo artigo aguardando modera√ß√£o",
    "articleId": "article-id",
    "authorName": "Jo√£o Silva"
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### üí¨ Novo Coment√°rio
```json
{
  "type": "NEW_COMMENT",
  "data": {
    "id": "comment-id",
    "content": "Excelente artigo!",
    "authorName": "Maria Santos",
    "targetId": "article-id"
  },
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

---

## üîß Troubleshooting

### ‚ùå "Token n√£o encontrado"
**Solu√ß√£o**: Execute primeiro os logins na se√ß√£o "1. AUTENTICA√á√ÉO"

### ‚ùå "WebSocket n√£o conecta"
**Solu√ß√µes**:
- Use Postman Desktop (n√£o web)
- Verifique se o servidor est√° rodando: `npm run start:dev`
- Confirme a URL: `ws://localhost:3001/notifications`
- Teste o health check na Collection

### ‚ùå "Forbidden" em modera√ß√£o
**Solu√ß√£o**: Use o `{{moderatorToken}}` em vez de `{{authToken}}`

### ‚ùå "Article not found"
**Solu√ß√£o**: Execute primeiro "Create Article" para gerar o `testArticleId`

### ‚ùå N√£o recebe eventos WebSocket
**Verifica√ß√µes**:
- Est√° conectado corretamente?
- Entrou na sala correta? (moderators/article_ID)
- Servidor est√° rodando e healthy?

---

## üéØ Fluxo de Teste Recomendado

### üöÄ Teste R√°pido (5 min)
```
1. Executar toda se√ß√£o "1. AUTENTICA√á√ÉO"
2. "Create Article" (se√ß√£o 2)
3. "Approve Article" (se√ß√£o 4) 
4. "Create Root Comment" (se√ß√£o 5)
5. "WebSocket Health Check" (se√ß√£o 8)
```

### üî• Teste Completo (20 min)
```
1. Executar TODAS as se√ß√µes em ordem
2. Configurar WebSocket paralelo
3. Testar cen√°rios tempo real
4. Verificar relat√≥rio final
```

### üß™ Teste de Stress (30 min)
```
1. Executar teste completo
2. Repetir se√ß√µes 2-7 m√∫ltiplas vezes
3. Testar casos de erro (se√ß√£o 9)
4. Monitorar performance
```

---

## üìà M√©tricas de Sucesso

**‚úÖ Teste 100% OK quando:**
- Success rate > 80% no relat√≥rio final
- WebSocket conecta e recebe eventos
- Tempo de resposta < 2s na busca
- Modera√ß√£o funciona corretamente
- Notifica√ß√µes em tempo real chegam

**üéâ Sistema pronto para produ√ß√£o!**

---

## üÜò Ajuda R√°pida

### üîó URLs importantes
- API Base: `http://localhost:3001`
- WebSocket: `ws://localhost:3001/notifications`
- Health: `http://localhost:3001/notifications/websocket/health`

### üé´ Tokens necess√°rios
- `{{authToken}}` - Usu√°rio comum
- `{{moderatorToken}}` - Moderador
- `{{refreshToken}}` - Para renovar

### üì± Vari√°veis principais
- `{{testArticleId}}` - ID do artigo de teste
- `{{testCommentId}}` - ID do coment√°rio de teste
- `{{baseUrl}}` - URL base da API

### üîå WebSocket essencial
- **Desktop only**: Postman Web n√£o funciona
- **Auth**: Query param ou header
- **Rooms**: `moderators`, `article_ID`
- **Events**: `ping`, `joinRoom`, `watchEntity`

---

**üéØ Pronto! Agora voc√™ tem tudo para testar completamente sua API DarkStack!**

**D√∫vidas?** Execute o "Generate Test Report" no final para ver um resumo completo! üìä